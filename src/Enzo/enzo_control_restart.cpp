// See LICENSE_CELLO file for license and copyright information

/// @file     enzo_control_restart.cpp
/// @author   James Bordner (jobordner@ucsd.edu)
/// @date     2022-03-10
/// @brief    Enzo-E portion of restart
/// @ingroup  Enzo
///
/// This file controls restarting from files generated by a previous call
/// to EnzoMethodCheck

//--------------------------------------------------

#include "enzo.hpp"

#include "charm_simulation.hpp"
#include "charm_mesh.hpp"
#include "main.hpp"

// #define TRACE

#ifdef TRACE
#   undef TRACE
#   define TRACE(MSG) \
  CkPrintf ("%d TRACE %s\n",CkMyPe(),std::string(MSG).c_str()); \
  fflush(stdout);
#else
#   define TRACE(MSG)  /* ... */
#endif


//----------------------------------------------------------------------

void Block::restart_enter_()
{
  TRACE("restart_enter_");
  const std::string restart_dir  = cello::config()->initial_restart_dir;
  if (index_.is_root()) {
    proxy_simulation[0].p_restart_enter(restart_dir);
  }
}

//----------------------------------------------------------------------

void Simulation::p_restart_enter (std::string restart_dir)
{
  // [ Called on root ip only ]

  // Create new empty IoEnzoReader chare array and distribute to other processing elements
  proxy_io_enzo_reader = CProxy_IoEnzoReader::ckNew();
  proxy_enzo_simulation.p_set_io_reader(proxy_io_enzo_reader);

  // Open and read the checkpoint hierarchy file
  std::ifstream file_hierarchy = file_open_file_list_(restart_dir);
  int num_files;
  file_hierarchy >> num_files;

  sync_restart_done_.set_stop(num_files);
  
  // Insert an IoEnzoReader element for each file
  for (int i=0; i<num_files; i++) {
    std::string file_name;
    file_hierarchy >> file_name;
    // Create ith io_reader to read file_name
    proxy_io_enzo_reader[i].insert(file_name);
    CkPrintf ("TRACE_RESTART file %d %s\n",i,file_name.c_str());
  }

  proxy_io_enzo_reader.doneInserting();

  

  // file_hierarchy << std::setfill('0');
  // int max_digits = log(check_num_files_-1)/log(10) + 1;
  // file_hierarchy << check_num_files_ << std::endl;
  // for (int i=0; i<check_num_files_; i++) {
  //   file_hierarchy << "block_data-" << std::setw(max_digits) << i << ".h5" << std::endl;
  // }

  // std::ifstream file_hierarchy = file_open_file_list_();
  //  ocheck.file_list 
  // open hierarchy file
  CkPrintf ("%d DEBUG_RESTART restart_dir = %s\n",CkMyPe(),restart_dir.c_str());
  // read hierarchy file
  CkPrintf("%d Main::restart_enter_ read hierarchy file\n",CkMyPe());
  // create block_array
  CkPrintf("%d Main::restart_enter_ create block array\n",CkMyPe());
  // create IoEnzoReader array
  CkPrintf("%d Main::restart_enter_ create IoEnzoReader array\n",CkMyPe());
  // initialize sync_file(num_io_reader)
  //  for (i_f = files in restart) {
  //    io_reader[i_f].insert(file_block);
  //  }
  // close hierarcy file
  CkPrintf("%d restart_enter_ close hierarchy file\n",CkMyPe());
  fflush(stdout);
}

//----------------------------------------------------------------------

IoEnzoReader::IoEnzoReader(std::string file_name) throw()
  : CBase_IoEnzoReader(),
    file_name_(file_name)
{
  CkPrintf ("%d IoEnzoReader(%s)\n",CkMyPe(),file_name.c_str());
  proxy_enzo_simulation[0].p_restart_done();
}
//----------------------------------------------------------------------

void EnzoSimulation::p_set_io_reader(CProxy_IoEnzoReader io_enzo_reader)
{
  proxy_io_enzo_reader = io_enzo_reader;
}

//----------------------------------------------------------------------

void EnzoSimulation::p_restart_done()
{
  TRACE("EnzoSimulation::p_restart_done");
  if (sync_restart_done_.next()) {
    enzo::block_array().p_restart_done();
  }
}

void EnzoBlock::p_restart_done()
{
  TRACE("EnzoBlock::p_restart_done()");
  adapt_exit_();
}

//======================================================================

std::ifstream Simulation::file_open_file_list_(std::string name_dir)
{
  std::string name_file = name_dir + "/check.file_list";

  std::ifstream file_hierarchy (name_file);

  ASSERT1("Simulation::file_copen_file_list_",
          "Cannot open hierarchy file %s for writing",
          name_file.c_str(),file_hierarchy);

  return file_hierarchy;
}

// //----------------------------------------------------------------------

// void Block::restart_enter_()
// {
//   TRACE_ENZO_RESTART_BLOCK("restart_enter_",this);
//   const std::string restart_dir  = cello::config()->initial_restart_dir;
//   const std::string restart_file = cello::config()->initial_restart_file;
//   if (index_.is_root()) {
//     proxy_main.p_restart_enter(restart_dir,restart_file);
//   }
// }

// //----------------------------------------------------------------------

// void Main::p_restart_enter
// (std::string restart_dir, std::string restart_file)
// {
//   // open hierarchy file
//   TRACE_RESTART_MAIN("Main::restart_enter_ open hierarchy file");
//   CkPrintf ("DEBUG_RESTART restart_dir = %s\n",restart_dir.c_str());
//   CkPrintf ("DEBUG_RESTART restart_file = %s\n",restart_file.c_str());
//   // read hierarchy file
//   TRACE_RESTART_MAIN("Main::restart_enter_ read hierarchy file");
//   // create block_array
//   TRACE_RESTART_MAIN("Main::restart_enter_ create block array");
//   // create IoEnzoReader array
//   TRACE_RESTART_MAIN("Main::restart_enter_ create IoEnzoReader array");
//   // initialize sync_file(num_io_reader)
//   //  for (i_f = files in restart) {
//   //    io_reader[i_f].insert(file_block);
//   //  }
//   // close hierarcy file
//   TRACE_RESTART_MAIN("restart_enter_ close hierarchy file");
// }
